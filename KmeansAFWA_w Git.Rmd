---
title: "AFWA K Means"
author: "Rich von Furstenberg"
date: "5/17/2021"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## K means analysis of AFWA Identity Items - The following code examines 4 clusters generated by k means clustering based on <span style="color:red"> 4 Identity Items (ID Environment, Conservation, Animal Rights, Wildlife Advocate) 5-20-21 </span>

```{r}
#Import Data
AFWA<-read.csv("C:\\Users\\rjvonfur\\Documents\\R\\R for 554\\Apr2021 RJV AFWA_22states.csv")
### This is the current data file as of 4-22-21

#Configuring the AFWA data for this analysis

#Renaming Social Identity variable from "TSC9752" (generated by SPSS 2-step Cluster Analysis) to more intuitive "Social_Identity". 
names(AFWA)[names(AFWA) == "TSC_9752"] <- "Social_Identity"

#Social_Identity needs to be changed from integer to factor
AFWA$Social_Identity<-as.factor(AFWA$Social_Identity)
#Change Social_Identity number to Name we use (Impassive, Consumptive, Protective)
levels(AFWA$Social_Identity) <- c("Impassive", "Consumptive", "Protective")

#Gender converted from 0 or 1 integer to factor 
AFWA$Gender_2Cat<-as.factor(AFWA$Gender_2Cat)
#Renaming Gender Factor Levels to names (Female/Other and Male)
levels(AFWA$Gender_2Cat) <- c("Female or Gender non IDing", "Male")

#Race_6Cat converted from integer to factor
AFWA$Race_6Cat<-as.factor(AFWA$Race_6Cat)
#Race_6Cat levels renamed from number to U.S. Census terms
levels(AFWA$Race_6Cat) <- c("White","Hispanic","Black","Asian","Am. Indian","All Others")

#Childhood Location_2Cat converted from integer to factor
AFWA$ChildhoodLocation_2Cat<-as.factor(AFWA$ChildhoodLocation_2Cat)
#Childhood Location_2Cat levels renamed from number to term 0 to rural/small city, 1 to med/large city  (urban) 
levels(AFWA$ChildhoodLocation_2Cat) <- c("Rural or Small City", "Med to Large City")

#CollegeMajor_2Cat converted from integer to factor
AFWA$CollegeMajor_2Cat<-as.factor(AFWA$CollegeMajor_2Cat)
#CollegeMajor_2Cat levels renamed from number 0 to All Other and 1 to Ag or NatRes
levels(AFWA$CollegeMajor_2Cat) <- c("All Other majors","Ag or Nat Resource")


#Drop Column "Identity Fisherman" "Rec_OtherTEXT because it's all NA's and really screws up analysis when doing NA omit, all data is thrown out.
AFWA= subset(AFWA, select = -c(Identity_Fisher)) 
AFWA= subset(AFWA, select = -c(Rec_OtherTEXT)) 
AFWA$OutdoorRecScore<-as.numeric(AFWA$OutdoorRecScore)
head(AFWA)
```

### Creating subset of AFWA data I will work with and omitting NA's

4 cluster option in this iteration (Using 4 identity Questions- NO hunter NO gun rights) -based on 5-19-21 phone convo w LL

```{r}
subset_kmeans <- AFWA[, c("Social_Identity", "WVO_Domination", "WVO_Mutualism", "Gender_3Cat", "Race_6Cat", "Race_2Cat", "Gender_2Cat", "HuntingApproval", "ConservationCaringScale", "HuntingActivitiesScale", "HuntApproval_Altruism", "HuntApproval_Egoism", "OutdoorRecScore", "ChildhoodLocation_2Cat", "CollegeMajor_2Cat", "Identity_WildlifeAdv", "Identity_AnimalRights", "Identity_Environment", "Identity_Conservation", "Identity_GunRights", "Identity_Hunter" )]
subset_kmeansNAomit<-na.omit(subset_kmeans)

#create Identity Question subset 
library(ggplot2)
library(dplyr)
 
identity_questions = subset(subset_kmeansNAomit, select = c(Identity_AnimalRights, Identity_Conservation, Identity_Environment, Identity_WildlifeAdv))
id_naomit<-na.omit(identity_questions)
```

## Generating Clusters

```{r, include=FALSE}
#4 is cluster number
library(animation)
set.seed(2345)
kmeans.ani(id_naomit, 4)

#Elbow Method to find Optimal k # https://www.guru99.com/r-k-means-clustering.html

#You create the function that runs the k-mean algorithm and store the total within clusters sum of squares 
kmean_withinss <- function(k) {
    cluster <- kmeans(id_naomit, k)
 return (cluster$tot.withinss)} 

# Set maximum cluster - setting to 10, far passed generalizable amount (3 to 4)
max_k <-10 
# Run algorithm over a range of k 
wss <- sapply(2:max_k, kmean_withinss)
# Create a data frame to plot the graph
elbow <-data.frame(2:max_k, wss)

# Plot the graph with ggplot
ggplot(elbow, aes(x = X2.max_k, y = wss)) +
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = seq(1, 10, by = 1))

#optimal cluster = 4  based on 5-19-21 phone convo w LL

opt_clust<-kmeans(id_naomit, 4)
#opt_clust$cluster #<- remove leftmost hashtag to have R generate graphics of the clustering
#opt_clust$centers #<- remove leftmost to hashtag to have R generate graphics of the clustering
#opt_clust$size	   #<- remove leftmost to hashtag to have R generate graphics of the clustering


#Let's create the reeshaped Dataset so we can make a HEATMAP

library(tidyr)
center <-opt_clust$centers
#center <- remove leftmost hashtag to have R generate graphics of the clustering

# create dataset with the cluster number

cluster <- c(1: 4)
center_df <- data.frame(cluster, center)

#Clustering over again w number set to 3 https://towardsdatascience.com/clustering-analysis-in-r-using-k-means-73eca4fb7967
set.seed(123)
clustering <- kmeans(id_naomit, centers = 4, nstart = 20)
#clustering <- remove leftmost hashtag to have R generate graphics of the clustering
```

## Cluster Validation

```{r}
#Clustering Validation- silohouette coeffient to evalute the goodness of clustering
library(cluster)
library(factoextra)

sil <- silhouette(clustering$cluster, dist(id_naomit))
fviz_silhouette(sil)

#Si > 0 means that the observation is well clustered. The closest it is to 1, the best it is clustered.
#Si > 0 means that the observation is well clustered. The closest it is to 1, the best it is clustered
#Si > 0 means that the observation is well clustered. The closest it is to 1, the best it is clustered.

#Clustering interpretation
library(GGally)
library(plotly)
```

## Cluster Mapping

```{r}
subset_kmeansNAomit$cluster <- as.factor(clustering$cluster)


#Cluster Mapping
#https://www.datanovia.com/en/blog/k-means-clustering-visualization-in-r-step-by-step-guide/
library(viridis)
fviz_cluster(clustering, data = id_naomit,
             palette = "viridis", 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )

```

## Comparing old clusters to new clusters

```{r}
library(ggmosaic)
#ADDING CLUSTERS TO SUBSET_KMEANSNAOMIT 
subset_kmeansNAomit$cluster <- as.factor(clustering$cluster)
table(subset_kmeansNAomit$Social_Identity, subset_kmeansNAomit$cluster)

# Plot Cluster Set vs Cluster Set
stackbar <- ggplot(data = subset_kmeansNAomit) + 
  geom_mosaic(aes(x=product(Social_Identity, cluster), fill = Social_Identity),
              divider=c("vspine", "hbar")) +   
  labs(x="4 Clusters (k-means)", y = "SPSS 2-Step Social ID (3_cat)", title = "Comparison of 2-step(SPSS) vs K-means(R)")
stackbar
```

## Using Violin Plots to Explore Cluster by ID Questions

```{r}
#New identities by ID Question

library(ggplot2)
# Basic violin plot ID Animal Rights
a <- ggplot(subset_kmeansNAomit, aes(x=cluster, y=Identity_AnimalRights, fill=cluster)) + 
  geom_violin() +
  geom_violin(adjust = 4) 
a

# Basic violin plot ID Conservation
a <- ggplot(subset_kmeansNAomit, aes(x=cluster, y=Identity_Conservation, fill=cluster)) + 
  geom_violin() +
  geom_violin(adjust = 4) 
a

# Basic violin plot ID Environment
a <- ggplot(subset_kmeansNAomit, aes(x=cluster, y=Identity_Environment, fill=cluster)) + 
  geom_violin() +
  geom_violin(adjust = 4) 
a

# Basic violin plot ID Wildlife Advocate
a <- ggplot(subset_kmeansNAomit, aes(x=cluster, y=Identity_WildlifeAdv, fill=cluster)) + 
  geom_violin() +
  geom_violin(adjust = 4) 
a

# Basic violin plot ID Gun Rights
a <- ggplot(subset_kmeansNAomit, aes(x=cluster, y=Identity_GunRights, fill=cluster)) + 
  geom_violin() +
  geom_violin(adjust = 2) 
a

# Basic violin plot ID Hunter
a <- ggplot(subset_kmeansNAomit, aes(x=cluster, y=Identity_Hunter, fill=cluster)) + 
  geom_violin() +
  geom_violin(adjust = 2) 
a


```

## Using Ridge Plots to Explore Clusters against ID Questions

```{r}

# Ridge Plots of 4 Cluster K Means vs 4 Identity Questions used to make them (+ ID GunRights and ID Hunter)

library(ggridges)

### 4 Clusters v Gun Rights 
ggplot(subset_kmeansNAomit, aes(x = Identity_GunRights, y = cluster, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "Mean Approval", option = "C") +
  labs(
    title = 'K Means Cluster ID by Identity GunRights',
    subtitle = 'AFWA Data Exploration'
  ) +
  theme_ridges(font_size = 13, grid = TRUE) + 
  theme(axis.title.y = element_blank())

### 4 Clusters v ID Hunter
ggplot(subset_kmeansNAomit, aes(x = Identity_Hunter, y = cluster, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "Mean Approval", option = "C") +
  labs(
    title = 'K Means Cluster ID by Identity Hunter',
    subtitle = 'AFWA Data Exploration'
  ) +
  theme_ridges(font_size = 13, grid = TRUE) + 
  theme(axis.title.y = element_blank())

### 4 Clusters vs Animal Rights
ggplot(subset_kmeansNAomit, aes(x = Identity_AnimalRights, y = cluster, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "Mean Approval", option = "C") +
  labs(
    title = 'K Means Cluster ID by Identity Animal Rights',
    subtitle = 'AFWA Data Exploration'
  ) +
  theme_ridges(font_size = 13, grid = TRUE) + 
  theme(axis.title.y = element_blank())

### 4 Clusters vs Identity Environment
ggplot(subset_kmeansNAomit, aes(x = Identity_Environment, y = cluster, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "Mean Approval", option = "C") +
  labs(
    title = 'K Means Cluster ID by Identity Environment',
    subtitle = 'AFWA Data Exploration'
  ) +
  theme_ridges(font_size = 13, grid = TRUE) + 
  theme(axis.title.y = element_blank())

### 4 Cluster vs Identity Conservation
ggplot(subset_kmeansNAomit, aes(x = Identity_Conservation, y = cluster, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "Mean Approval", option = "C") +
  labs(
    title = 'K Means Cluster ID by Identity Conservation',
    subtitle = 'AFWA Data Exploration'
  ) +
  theme_ridges(font_size = 13, grid = TRUE) + 
  theme(axis.title.y = element_blank())

### 4 Cluster vs Identity Wildlife Advocate
ggplot(subset_kmeansNAomit, aes(x = Identity_WildlifeAdv, y = cluster, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "Mean Approval", option = "C") +
  labs(
    title = 'K Means Cluster ID by Identity Wildlife Advocate',
    subtitle = 'AFWA Data Exploration'
  ) +
  theme_ridges(font_size = 13, grid = TRUE) + 
  theme(axis.title.y = element_blank())

```

## Using Proportion Plots of Clusters vs Outcome Variables of Interest

```{r}

# WVOs by Cluster Proportion Plot
#https://psyteachr.github.io/msc-data-skills/ggplot.html

ggplot(subset_kmeansNAomit, aes(WVO_Domination, WVO_Mutualism, colour = cluster)) +
   geom_count(position="jitter")

# ConservationCaring x ID GunRights x Cluster

ggplot(subset_kmeansNAomit, aes(ConservationCaringScale, Identity_GunRights, colour = cluster)) +
   geom_count(position="jitter")

# ID Hunter x GunRights x Cluster

ggplot(subset_kmeansNAomit, aes(Identity_Hunter, Identity_GunRights, colour = cluster)) +
   geom_count(position="jitter")

# ID Environment x GunRights x Cluster

ggplot(subset_kmeansNAomit, aes(Identity_Environment, Identity_GunRights, colour = cluster)) +
   geom_count(position="jitter")

# HuntApprovEgo x HuntApprovAlt x Cluster
ggplot(subset_kmeansNAomit, aes(HuntApproval_Altruism, HuntApproval_Egoism, colour = cluster)) +
   geom_count(position="jitter")
###################### A look at Gender vs GunRights as possible wedge issue
# ID GunRights x ConservationCaring x Gender
ggplot(subset_kmeansNAomit, aes(ConservationCaringScale, Identity_GunRights, colour = Gender_2Cat)) +
   geom_count(position="jitter")

# ID GunRights x WVO Mutualism x Gender
ggplot(subset_kmeansNAomit, aes(WVO_Mutualism, Identity_GunRights, colour = Gender_2Cat)) +
   geom_count(position="jitter")

# ID GunRights x WVO Domination x Gender
ggplot(subset_kmeansNAomit, aes(WVO_Domination, Identity_GunRights, colour = Gender_2Cat)) +
   geom_count(position="jitter")

# WVO Mutualism x WVO Domination x Gender
ggplot(subset_kmeansNAomit, aes(WVO_Domination, WVO_Mutualism, colour = Gender_2Cat)) +
   geom_count(position="jitter")

```

## Demographics of clusters

```{r}
### Table of Race vs Cluster- Percentage breakdown
mytable <- table(subset_kmeansNAomit$Race_6Cat, subset_kmeansNAomit$cluster) # A will be rows, B will be columns
mytable # print table

margin.table(mytable, 1) # A frequencies (summed over B)
margin.table(mytable, 2) # B frequencies (summed over A)

prop.table(mytable) # cell percentages
prop.table(mytable, 1) # row percentages
prop.table(mytable, 2) # column percentages 

### Bar charts

library(scales)

#Cluster as composed by Race
ggplot(subset_kmeansNAomit, 
       aes(x = factor(cluster),
                      #levels = c("Am. Indian", "Asian", 
                                #"Black", "Hispanic", 
                              #  "White", "All Others")),
           fill = factor(Race_6Cat,
  levels = c("Am. Indian", "Asian", 
                                "Black", "Hispanic", 
                                "White", "All Others"))))+
                         #, 
                        # levels = c("f", "r", "4"),
                        # labels = c("front-wheel", 
                                   # "rear-wheel", 
                                 # "4-wheel")))) + 
  geom_bar(position = "fill") +
  scale_y_continuous(breaks = seq(0, 1, .2), 
                     label = percent) +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Percent", 
       fill = "Race (U.S. Census term)",
       x = "Cluster",
       title = "Cluster x Race Composition") +
  theme_minimal()

#### Clusters by Gender 2 Cat

ggplot(subset_kmeansNAomit, 
       aes(x = factor(cluster),
                      #levels = c("Am. Indian", "Asian", 
                               # "Black", "Hispanic", 
                               # "White", "All Others")),
           fill = factor(Gender_2Cat)))+
                         #, 
                        # levels = c("f", "r", "4"),
                        # labels = c("front-wheel", 
                                   # "rear-wheel", 
                                   # "4-wheel")))) + 
  geom_bar(position = "fill") +
  scale_y_continuous(breaks = seq(0, 1, .2), 
                     label = percent) +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Percent", 
       fill = "Gender 2Cat",
       x = "Cluster",
       title = "Cluster x Gender Composition") +
  theme_minimal()

#### Clusters by Childhood Location (2_cat)

ggplot(subset_kmeansNAomit, 
       aes(x = factor(cluster),
                      #levels = c("Am. Indian", "Asian", 
                               # "Black", "Hispanic", 
                               # "White", "All Others")),
           fill = factor(ChildhoodLocation_2Cat)))+
                         #, 
                        # levels = c("f", "r", "4"),
                        # labels = c("front-wheel", 
                                   # "rear-wheel", 
                                   # "4-wheel")))) + 
  geom_bar(position = "fill") +
  scale_y_continuous(breaks = seq(0, 1, .2), 
                     label = percent) +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Percent", 
       fill = "ChildhoodLocation_2Cat",
       x = "Cluster",
       title = "Cluster x Childhood Location (2_Cat)") +
  theme_minimal()

#### Clusters by College Major (2_cat)

ggplot(subset_kmeansNAomit, 
       aes(x = factor(cluster),
                      #levels = c("Am. Indian", "Asian", 
                               # "Black", "Hispanic", 
                               # "White", "All Others")),
           fill = factor(CollegeMajor_2Cat)))+
                         #, 
                        # levels = c("f", "r", "4"),
                        # labels = c("front-wheel", 
                                   # "rear-wheel", 
                                   # "4-wheel")))) + 
  geom_bar(position = "fill") +
  scale_y_continuous(breaks = seq(0, 1, .2), 
                     label = percent) +
  scale_fill_brewer(palette = "Set2") +
  labs(y = "Percent", 
       fill = "CollegeMajor_2Cat",
       x = "Cluster",
       title = "Cluster x College Major (2_cat)") +
  theme_minimal()
```

